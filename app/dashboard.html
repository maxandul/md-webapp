<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mitarbeitergespr√§che</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body style="background: #f5f5f5;">
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>Meine Mitarbeitergespr√§che</h1>
                <p id="welcomeText">Willkommen</p>
            </div>
            <div class="user-info">
                <p id="userName"></p>
                <p id="userRole"></p>
                <button class="logout-btn" onclick="logout()">Abmelden</button>
            </div>
        </div>

        <!-- Statistiken -->
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">Gesamt</div>
            </div>
            <div class="stat-card stat-geplant">
                <div class="stat-number" id="statGeplant">0</div>
                <div class="stat-label">Geplant</div>
            </div>
            <div class="stat-card stat-bearbeitung">
                <div class="stat-number" id="statBearbeitung">0</div>
                <div class="stat-label">In Bearbeitung</div>
            </div>
            <div class="stat-card stat-abgeschlossen">
                <div class="stat-number" id="statAbgeschlossen">0</div>
                <div class="stat-label">Abgeschlossen</div>
            </div>
        </div>

        <!-- Gespr√§che Liste -->
        <div class="gespraeche-liste">
            <h2>Alle Gespr√§che</h2>
            
            <div id="loadingSpinner" class="loading">
                <div class="spinner"></div>
                <p>Lade Gespr√§che...</p>
            </div>
            
            <div id="gespraecheContainer" style="display: none;">
                <!-- Wird mit JavaScript gef√ºllt -->
            </div>
            
            <div id="errorContainer" style="display: none;" class="error-message">
                <!-- Fehlermeldungen -->
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let allGespraeche = [];

        // Beim Laden: Auth checken und Daten laden
        window.addEventListener('DOMContentLoaded', async () => {
            // Check ob eingeloggt
            const token = sessionStorage.getItem('app_token');
            const userData = sessionStorage.getItem('user_data');
            
            if (!token || !userData) {
                window.location.href = 'index.html';
                return;
            }
            
            const user = JSON.parse(userData);
            
            // User-Info anzeigen
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userRole').textContent = user.rolle === 'HR' ? 'HR Team' : 'F√ºhrungskraft';
            document.getElementById('welcomeText').textContent = `Willkommen, ${user.name.split(' ')[0]}!`;
            
            // Gespr√§che laden
            await loadGespraeche(token);
        });

        async function loadGespraeche(token) {
            try {
                const response = await fetch('/api/gespraeche', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Fehler beim Laden der Gespr√§che');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allGespraeche = data.gespraeche;
                    displayGespraeche(allGespraeche);
                    updateStats(allGespraeche);
                } else {
                    showError('Fehler beim Laden der Gespr√§che');
                }
                
            } catch (error) {
                console.error('Fehler:', error);
                showError('Verbindungsfehler zum Server');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayGespraeche(gespraeche) {
            const container = document.getElementById('gespraecheContainer');
            
            if (gespraeche.length === 0) {
                container.innerHTML = '<p class="empty-state">Keine Gespr√§che vorhanden</p>';
                container.style.display = 'block';
                return;
            }
            
            container.innerHTML = gespraeche.map(g => `
                <div class="gespraech-card" onclick="openGespraech(${g.Gespraechs_ID})">
                    <div class="gespraech-header">
                        <div class="gespraech-name">
                            ${g.Vorname} ${g.Nachname}
                        </div>
                        <div class="status-badge status-${getStatusClass(g.Status)}">
                            ${g.Status}
                        </div>
                    </div>
                    <div class="gespraech-details">
                        <p>üìç ${g.Abteilung || 'Keine Abteilung'}</p>
                        <p>üìÖ ${g.Datum || 'Termin noch nicht festgelegt'}</p>
                        <p>üÜî Personalnummer: ${g.MA_PersonalNr}</p>
                    </div>
                </div>
            `).join('');
            
            container.style.display = 'block';
        }

        function updateStats(gespraeche) {
            const stats = {
                total: gespraeche.length,
                geplant: gespraeche.filter(g => g.Status === 'Geplant').length,
                bearbeitung: gespraeche.filter(g => g.Status === 'In Bearbeitung').length,
                abgeschlossen: gespraeche.filter(g => g.Status === 'Abgeschlossen').length
            };
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statGeplant').textContent = stats.geplant;
            document.getElementById('statBearbeitung').textContent = stats.bearbeitung;
            document.getElementById('statAbgeschlossen').textContent = stats.abgeschlossen;
        }

        function getStatusClass(status) {
            const map = {
                'Geplant': 'geplant',
                'In Bearbeitung': 'bearbeitung',
                'Abgeschlossen': 'abgeschlossen'
            };
            return map[status] || 'geplant';
        }

        function openGespraech(id) {
            window.location.href = `gespraech.html?id=${id}`;
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = '‚ùå ' + message;
            errorContainer.style.display = 'block';
            document.getElementById('gespraecheContainer').style.display = 'none';
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>